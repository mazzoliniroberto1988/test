<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DzTimbratore</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser@9.0.1/dist/bundle/index.umd.min.js"></script>
</head>
<body>
    <div id="app">
        <div id="loading-view" class="view view-centered active">
            <div class="spinner"></div>
        </div>

        <div id="login-view" class="view view-centered">
            <div class="card" style="max-width: 400px;">
                <h2 style="text-align: center; border: none; margin-bottom: 20px;">DzTimbratore</h2>
                
                <div>
                    <label for="username">Username</label>
                    <input type="text" id="username"  required autocomplete="username webauthn">
                </div>

                <div class="login-actions-row">
                    
                    <button type="button" id="btn-mode-password" class="btn-square">
                        <span class="material-icons-round">vpn_key</span>
                        <span>Password</span>
                    </button>

                    <button type="button" id="btn-mode-bio" class="btn-square">
                        <span class="material-icons-round">fingerprint</span>
                        <span>Biometria</span>
                    </button>
                </div>

                <form id="login-form-password" class="hidden fade-in-down">
                    <div>
                        <label for="password">Password</label>
                        <input type="password" id="password" required autocomplete="current-password">
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="ricordami">
                        <label for="ricordami">Ricordami per 30 giorni</label>
                    </div>
                    <button type="submit" id="btn-submit-password" class="button">Accedi</button>
                </form>

                <div class="error hidden" id="login-error"></div>
            </div>
        </div>

        <div id="employee-view" class="view">
            <header class="mobile-header">
                <div class="logo">Timbratura</div>
                <div class="user-info">
                    <strong id="employee-name"></strong>
                    <a href="#" id="logout-button" class="logout">Esci</a>
                </div>
            </header>
            
            <main class="mobile-main">
                <div class="card">
                    <div id="digital-clock">00:00:00</div>
                    <p id="current-status">Pronto per timbrare.</p>
                    <button id="timbra-button" class="button" disabled>Caricamento...</button>
                    <p id="timbra-status"></p>
                </div>
                
                <div class="card" id="bio-card" style="display: none;">
                    <h2>Impostazioni Accesso</h2>
                    
                    <div id="bio-setup-view">
                        <p>Abilita l'accesso con impronta/volto per accedere più velocemente.</p>
                        <button id="register-bio-button" class="button button-secondary" style="margin-top: 10px;">
                            Abilita Accesso Biometrico
                        </button>
                    </div>

                    <div id="bio-remove-view" class="hidden">
                        <p style="color: var(--success-green); margin-bottom: 10px;">✓ Accesso biometrico attivo.</p>
                        <button id="remove-bio-button" class="button button-danger button-sm">
                            Disabilita / Rimuovi
                        </button>
                    </div>
                    
                    <p id="bio-card-status" style="margin-top:10px; font-size: 0.9em;"></p>
                </div>

                <div class="card">
                    <h2>Timbrature Recenti</h2>
                    <ul class="log-list" id="employee-log-body">
                        <li class="no-items">Nessuna timbratura recente.</li>
                    </ul>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Costanti globali
        const API_BASE_URL = 'api/';
        const TOKEN_SELECTOR_KEY = 'dz_token_selector';
        const TOKEN_VALIDATOR_KEY = 'dz_token_validator';
        
        const { startRegistration, startAuthentication } = (window.SimpleWebAuthnBrowser || {});

        document.addEventListener('DOMContentLoaded', () => {
            
            let currentUser = null;
            let lastTimbratura = null;
            let clockInterval = null;

            // Selettori DOM
            const views = {
                loading: document.getElementById('loading-view'),
                login: document.getElementById('login-view'),
                employee: document.getElementById('employee-view')
            };
            
            // Elementi Login
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const ricordamiInput = document.getElementById('ricordami');
            const loginFormPassword = document.getElementById('login-form-password');
            const loginError = document.getElementById('login-error');
            
            // Bottoni Login
            const btnModePassword = document.getElementById('btn-mode-password');
            const btnModeBio = document.getElementById('btn-mode-bio');
            
            // Elementi Employee
            const employeeName = document.getElementById('employee-name');
            const logoutButton = document.getElementById('logout-button');
            const currentStatus = document.getElementById('current-status');
            const timbraButton = document.getElementById('timbra-button');
            const timbraStatus = document.getElementById('timbra-status');
            const employeeLogBody = document.getElementById('employee-log-body');
            const digitalClock = document.getElementById('digital-clock');
            
            // Elementi Biometria
            const bioCard = document.getElementById('bio-card');
            const bioSetupView = document.getElementById('bio-setup-view');
            const bioRemoveView = document.getElementById('bio-remove-view');
            const bioCardStatus = document.getElementById('bio-card-status');
            const registerBioButton = document.getElementById('register-bio-button');
            const removeBioButton = document.getElementById('remove-bio-button');

            // --- FUNZIONI UI ---

            function showView(viewName) {
                Object.values(views).forEach(v => v.classList.remove('active'));
                if (views[viewName]) { views[viewName].classList.add('active'); }
            }

            function showLoginError(message) { loginError.textContent = message; loginError.classList.remove('hidden'); }
            function clearLoginError() { loginError.textContent = ''; loginError.classList.add('hidden'); }

            // Toggle Modalità Login
            btnModePassword.addEventListener('click', () => {
                clearLoginError();
                loginFormPassword.classList.remove('hidden');
                btnModePassword.classList.add('active');
                btnModeBio.classList.remove('active');
                passwordInput.focus();
            });

            btnModeBio.addEventListener('click', () => {
                clearLoginError();
                loginFormPassword.classList.add('hidden');
                btnModePassword.classList.remove('active');
                btnModeBio.classList.add('active');
                handleLoginBio(); 
            });

            async function fetchAPI(endpoint, options = {}) {
                let response;
                try {
                    response = await fetch(API_BASE_URL + endpoint, options);
                    const rawText = await response.text(); 
                    if (!response.ok) {
                        try { 
                            const errData = JSON.parse(rawText);
                            throw new Error(errData.message || `Errore ${response.status}`);
                        } catch (e) {
                            throw new Error(`Errore server (${response.status}).`);
                        }
                    }
                    return JSON.parse(rawText);
                } catch (error) { throw error; }
            }

            function startClock() {
                if (clockInterval) clearInterval(clockInterval);
                function updateClock() {
                    const now = new Date();
                    digitalClock.textContent = now.toLocaleTimeString('it-IT');
                }
                updateClock();
                clockInterval = setInterval(updateClock, 1000);
            }

            function initializeEmployeeView(user) {
                currentUser = user;
                employeeName.textContent = user.nome;
                loadEmployeeData();
                startClock();
                showView('employee');
                checkBioStatus();
            }

            // --- LOGICA STATO BIOMETRIA ---
            async function checkBioStatus() {
                bioCard.style.display = 'block'; 
                bioCardStatus.textContent = '';
                try {
                    const response = await fetchAPI('webauthn_login_start.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: currentUser.username })
                    });

                    if (response.success) {
                        bioSetupView.classList.add('hidden');
                        bioRemoveView.classList.remove('hidden');
                    } else {
                        bioSetupView.classList.remove('hidden');
                        bioRemoveView.classList.add('hidden');
                    }
                } catch (e) {
                    bioSetupView.classList.remove('hidden');
                    bioRemoveView.classList.add('hidden');
                }
            }

            // --- RIMUOVI BIOMETRIA ---
            removeBioButton.addEventListener('click', async () => {
                if(!confirm("Sei sicuro di voler disattivare l'accesso biometrico?")) return;
                bioCardStatus.textContent = "Rimozione...";
                try {
                    const data = await fetchAPI('remove_biometry.php', { method: 'POST' });
                    if(data.success) {
                        alert(data.message);
                        checkBioStatus();
                    } else {
                        bioCardStatus.textContent = "Errore: " + data.message;
                    }
                } catch (error) {
                    bioCardStatus.textContent = "Errore: " + error.message;
                }
            });

            // --- REGISTRA BIOMETRIA ---
            registerBioButton.addEventListener('click', async () => {
                registerBioButton.disabled = true;
                bioCardStatus.textContent = 'Attendi...';
                try {
                    const optionsResponse = await fetchAPI('webauthn_register_start.php', { method: 'POST' });
                    if (!optionsResponse.success) throw new Error(optionsResponse.message);
                    
                    bioCardStatus.textContent = 'Tocca il sensore...';
                    const attestation = await startRegistration(optionsResponse.options);
                    
                    bioCardStatus.textContent = 'Salvataggio...';
                    const verificationResponse = await fetchAPI('webauthn_register_finish.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(attestation)
                    });

                    if (!verificationResponse.success) throw new Error(verificationResponse.message);
                    alert('Accesso biometrico attivato!');
                    checkBioStatus();
                } catch (error) {
                    bioCardStatus.textContent = `Errore: ${error.message}`;
                } finally {
                    registerBioButton.disabled = false;
                }
            });

            // --- SESSIONE ---
            async function checkSession() {
                try {
                    const sessionData = await fetchAPI('check_session.php');
                    if (sessionData.user.ruolo === 'employee') {
                        initializeEmployeeView(sessionData.user);
                    } else {
                        showView('login');
                    }
                } catch (sessionError) {
                    const selettore = localStorage.getItem(TOKEN_SELECTOR_KEY);
                    const validatore = localStorage.getItem(TOKEN_VALIDATOR_KEY);
                    if (selettore && validatore) {
                        try {
                            const tokenData = await fetchAPI('check_session.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ selettore, validatore })
                            });
                            if (tokenData.user.ruolo === 'employee') {
                                initializeEmployeeView(tokenData.user);
                            } else {
                                clearTokenStorage(); showView('login');
                            }
                        } catch (tokenError) {
                            clearTokenStorage(); showView('login');
                        }
                    } else {
                        showView('login');
                    }
                }
            }
            
            function saveTokenStorage(token) {
                if (token && token.selettore && token.validatore) {
                    localStorage.setItem(TOKEN_SELECTOR_KEY, token.selettore);
                    localStorage.setItem(TOKEN_VALIDATOR_KEY, token.validatore);
                }
            }
            function clearTokenStorage() {
                localStorage.removeItem(TOKEN_SELECTOR_KEY);
                localStorage.removeItem(TOKEN_VALIDATOR_KEY);
            }

            // --- LOGIN PASSWORD ---
            loginFormPassword.addEventListener('submit', async (e) => {
                e.preventDefault();
                clearLoginError();
                const btn = document.getElementById('btn-submit-password');
                btn.disabled = true; btn.textContent = 'Accesso...';
                
                try {
                    const data = await fetchAPI('login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: usernameInput.value,
                            password: passwordInput.value,
                            ricordami: ricordamiInput.checked
                        })
                    });
                    if (data.user.ruolo !== 'employee') {
                        showLoginError("Accesso riservato ai dipendenti.");
                        await fetchAPI('logout.php'); 
                        return;
                    }
                    if (ricordamiInput.checked && data.token) { saveTokenStorage(data.token); }
                    initializeEmployeeView(data.user);
                } catch (error) {
                    showLoginError(error.message);
                } finally {
                    btn.disabled = false; btn.textContent = 'Accedi';
                }
            });

            // --- LOGIN BIO ---
            async function handleLoginBio() {
                clearLoginError();
                const username = usernameInput.value;
                if (!username) {
                    showLoginError('Inserisci prima il tuo username.');
                    btnModeBio.classList.remove('active');
                    return;
                }

                try {
                    const optionsResponse = await fetchAPI('webauthn_login_start.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username })
                    });
                    if (!optionsResponse.success) throw new Error(optionsResponse.message);

                    const assertion = await startAuthentication(optionsResponse.options);
                    
                    const verificationResponse = await fetchAPI('webauthn_login_finish.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(assertion)
                    });
                    
                    if (!verificationResponse.success) throw new Error(verificationResponse.message);
                    initializeEmployeeView(verificationResponse.user);

                } catch (error) {
                    let msg = error.message;
                    if (msg.includes('User cancelled')) msg = "Annullato dall'utente.";
                    if (msg.includes('Nessuna biometria')) msg = "Nessuna impronta registrata.";
                    showLoginError(msg);
                    btnModeBio.classList.remove('active');
                }
            }
            
            // --- LOGOUT ---
            async function handleLogout() {
                if (clockInterval) clearInterval(clockInterval);
                try {
                    const selettore = localStorage.getItem(TOKEN_SELECTOR_KEY);
                    await fetchAPI('logout.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ selettore })
                    });
                } catch (error) { console.error("Errore logout:", error); }
                clearTokenStorage();
                currentUser = null;
                usernameInput.value = ''; passwordInput.value = '';
                ricordamiInput.checked = false;
                loginFormPassword.classList.add('hidden');
                btnModeBio.classList.remove('active');
                btnModePassword.classList.remove('active');
                showView('login');
            }
            
            // --- DATI ---
            async function loadEmployeeData() {
                try {
                    const data = await fetchAPI('get_data.php');
                    lastTimbratura = data.last_timbratura;
                    updateTimbraButton();
                    updateRecentLogs(data.recent_logs);
                } catch (error) {
                    timbraStatus.textContent = "Errore caricamento.";
                    if (String(error.message).includes("401")) { handleLogout(); }
                }
            }
            
            function updateTimbraButton() {
                timbraButton.disabled = false;
                timbraStatus.textContent = '';
                if (!lastTimbratura || lastTimbratura.tipo === 'uscita') {
                    currentStatus.textContent = "Pronto per timbrare l'Entrata.";
                    timbraButton.textContent = 'TIMBRA ENTRATA';
                    timbraButton.className = 'button button-success';
                } else {
                    const ora = new Date(lastTimbratura.timestamp).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    currentStatus.textContent = `Entrato alle ${ora}.`;
                    timbraButton.textContent = 'TIMBRA USCITA';
                    timbraButton.className = 'button button-danger';
                }
            }
            
            function updateRecentLogs(logs) {
                employeeLogBody.innerHTML = '';
                if (!logs || logs.length === 0) {
                    employeeLogBody.innerHTML = '<li class="no-items">Nessuna timbratura recente.</li>';
                    return;
                }
                logs.forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'log-item';
                    const dataFormat = new Date(log.timestamp).toLocaleString('it-IT');
                    const tipoText = log.tipo === 'entrata' ? 'Entrata' : 'Uscita';
                    li.innerHTML = `<span>${dataFormat}</span> <span class="tipo-${log.tipo}">${tipoText}</span>`;
                    employeeLogBody.appendChild(li);
                });
            }
            
            async function handleTimbra() {
                timbraButton.disabled = true;
                timbraStatus.textContent = 'Richiesta posizione...';
                try {
                    const position = await getGeoLocation();
                    timbraStatus.textContent = 'Invio...';
                    const { latitude, longitude } = position.coords;
                    const tipo = (!lastTimbratura || lastTimbratura.tipo === 'uscita') ? 'entrata' : 'uscita';
                    
                    const data = await fetchAPI('timbra.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tipo, latitudine: latitude, longitudine: longitude })
                    });
                    
                    timbraStatus.textContent = data.message;
                    await loadEmployeeData();
                } catch (error) {
                    timbraStatus.textContent = `Errore: ${error.message}`;
                    timbraButton.disabled = false;
                }
            }
            
            function getGeoLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) { reject(new Error('GPS non supportato.')); return; }
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve(pos),
                        (err) => reject(new Error('Posizione non disponibile.')),
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                });
            }

            // --- BINDING EVENTI ---
            logoutButton.addEventListener('click', handleLogout);
            timbraButton.addEventListener('click', handleTimbra);

            // --- START ---
            showView('loading');
            checkSession();
        });
    </script>
</body>
</html>