<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello Admin - DzTimbratore</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/forms.css">
    <link rel="stylesheet" href="../css/components.css">
    
    <style>
        /* Rimuovo gli stili inline e uso i tuoi */
        body { display: block; min-height: 100vh; }
        .admin-main { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .login-view-admin {
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; min-height: 100vh; padding: 20px;
        }
        .login-container { width: 100%; max-width: 450px; }
        .login-container h1 { font-size: 1.8em; text-align: center; color: var(--primary-blue); margin-bottom: 5px;}
        .login-container h2 { font-size: 1.2em; text-align: center; color: var(--secondary-gray); margin-top: 0; margin-bottom: 20px; }
        
        /* Stili per Tab (come prima) */
        .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 15px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;}
        .tab-link:hover { color: var(--primary-blue); }
        .tab-link.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        /* Stile per filtri (usa i tuoi stili .button) */
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filter-bar .button-wrapper { display: flex; gap: 10px; align-self: end; }
        .filter-bar .button { width: 100%; }

        /* Stili per la nuova tabella a griglia */
        .grid-table .orario { font-weight: 600; font-size: 1.1em; }
        .grid-table .tipo { font-size: 0.9em; }
        .grid-table .tipo.entrata { color: var(--success-green); }
        .grid-table .tipo.uscita { color: var(--danger-red); }
        .grid-table .posizione { font-size: 0.8em; color: var(--secondary-gray); }
        .grid-table td, .grid-table th { text-align: center; vertical-align: middle; }
        .grid-table td:first-child { font-weight: bold; background: #f8f9fa; }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading-view" class="login-view-admin"> <div class="spinner"></div> </div>
        
        <div id="login-view" class="login-view-admin" style="display: none;">
            <div class="content-section login-container">
                <h1>DzTimbratore</h1> <h2>Pannello Admin</h2>
                <form id="login-form">
                    <div> <label for="username">Username</label> <input type="text" id="username" placeholder="admin" required> </div>
                    <div> <label for="password">Password</label> <input type="password" id="password" required> </div>
                    <div class="checkbox-wrapper"> <input type="checkbox" id="ricordami"> <label for="ricordami">Ricordami</label> </div>
                    <div class="error hidden" id="login-error"></div>
                    <button type="submit" id="login-button" class="button" style="width: 100%; padding: 10px;">Accedi</button>
                </form>
            </div>
        </div>

        <div id="admin-view" class="view" style="display: none;">
            <header class="main-header">
                <div class="logo">Admin DzTimbratore</div>
                <nav> <span>Benvenuto, <strong id="admin-name"></strong></span> <a href="#" id="logout-button">Esci</a> </nav>
            </header>
            
            <main class="admin-main">
                <div class="tab-nav">
                    <a class="tab-link active" data-tab="log">Riepilogo Mensile</a>
                    <a class="tab-link" data-tab="utenti">Gestione Utenti</a>
                </div>
                
                <div id="tab-log" class="tab-pane active">
                    <div class="content-section">
                        <form id="filter-form">
                            <div class="filter-bar">
                                <div>
                                    <label for="filter-dipendente">Dipendente</label>
                                    <select id="filter-dipendente" name="dipendente" required></select>
                                </div>
                                <div>
                                    <label for="filter-mese">Mese</label>
                                    <select id="filter-mese" name="mese" required></select>
                                </div>
                                <div>
                                    <label for="filter-anno">Anno</label>
                                    <select id="filter-anno" name="anno" required></select>
                                </div>
                                <div class="button-wrapper">
                                    <button type="submit" class="button button-primary">Mostra</button>
                                    <button type="button" id="export-excel-button" class="button button-success">Esporta</button>
                                </div>
                            </div>
                        </form>
                        <div class="table-responsive grid-table">
                            <table id="log-table">
                                <thead id="log-table-head">
                                    </thead>
                                <tbody id="log-table-body">
                                    </tbody>
                            </table>
                        </div>
                        <div id="log-table-placeholder" class="no-items-message" style="padding: 20px; text-align: center;">
                            Seleziona un dipendente, un mese e un anno per visualizzare il riepilogo.
                        </div>
                    </div>
                </div>
                
                <div id="tab-utenti" class="tab-pane">
                    <div class="content-section">
                        <h2>Crea Nuovo Utente</h2>
                        <form id="create-user-form">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div> <label for="new_username">Username</label> <input type="text" id="new_username" required> </div>
                                <div> <label for="new_password">Password</label> <input type="password" id="new_password" required> </div>
                                <div> <label for="new_nome">Nome</label> <input type="text" id="new_nome" required> </div>
                                <div> <label for="new_cognome">Cognome</label> <input type="text" id="new_cognome" required> </div>
                                <div>
                                    <label for="new_ruolo">Ruolo</label>
                                    <select id="new_ruolo"> <option value="employee">Employee</option> <option value="admin">Admin</option> </select>
                                </div>
                            </div>
                            <div class="error hidden" id="create-user-error"></div>
                            <button type="submit" class="button button-success" style="margin-top: 15px;">Crea Utente</button>
                        </form>
                    </div>
                    <div class="content-section">
                        <h2>Elenco Utenti</h2>
                        <div class="table-responsive">
                            <table>
                                <thead> <tr> <th>Username</th> <th>Nome</th> <th>Ruolo</th> <th>Azioni</th> </tr> </thead>
                                <tbody id="admin-users-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = '../api/';
        const TOKEN_SELECTOR_KEY = 'dz_admin_token_selector';
        const TOKEN_VALIDATOR_KEY = 'dz_admin_token_validator';
        let currentUser = null;
        let listaUtenti = []; // Memorizza la lista utenti

        // Selettori DOM
        const views = { loading: document.getElementById('loading-view'), login: document.getElementById('login-view'), admin: document.getElementById('admin-view') };
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const ricordamiInput = document.getElementById('ricordami');
        const adminName = document.getElementById('admin-name');
        const logoutButton = document.getElementById('logout-button');
        const adminUsersBody = document.getElementById('admin-users-body');
        const createUserForm = document.getElementById('create-user-form');
        const createUserError = document.getElementById('create-user-error');
        
        // Selettori Griglia
        const filterForm = document.getElementById('filter-form');
        const filterDipendente = document.getElementById('filter-dipendente');
        const filterMese = document.getElementById('filter-mese');
        const filterAnno = document.getElementById('filter-anno');
        const exportExcelButton = document.getElementById('export-excel-button');
        const logTable = document.getElementById('log-table');
        const logTableHead = document.getElementById('log-table-head');
        const logTableBody = document.getElementById('log-table-body');
        const logTablePlaceholder = document.getElementById('log-table-placeholder');

        // --- FUNZIONI BASE (Login, Auth, Utils) ---
        function showView(viewName) {
            Object.values(views).forEach(v => v.style.display = 'none');
            if (views[viewName]) { views[viewName].style.display = (viewName === 'admin') ? 'block' : 'flex'; }
        }
        function showLoginError(message) { loginError.textContent = message; loginError.classList.remove('hidden'); }
        function clearLoginError() { loginError.textContent = ''; loginError.classList.add('hidden'); }
        function showCreateError(message) { createUserError.textContent = message; createUserError.classList.remove('hidden'); }
        function clearCreateError() { createUserError.textContent = ''; createUserError.classList.add('hidden'); }
        
        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(API_BASE_URL + endpoint, options);
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.message || `Errore ${response.status}`); }
                return response.json();
            } catch (error) { console.error('Errore FetchAPI:', error); throw error; }
        }

        function initializeAdminView(user) {
            currentUser = user;
            adminName.textContent = user.nome;
            populateFilterDropdowns();
            loadInitialAdminData(); // Carica solo la lista utenti
            setupTabs();
            showView('admin');
        }

        async function checkSession() {
            try {
                const sessionData = await fetchAPI('check_session.php');
                if (sessionData.user.ruolo === 'admin') { initializeAdminView(sessionData.user); } else { showView('login'); }
                return;
            } catch (sessionError) {
                const selettore = localStorage.getItem(TOKEN_SELECTOR_KEY);
                const validatore = localStorage.getItem(TOKEN_VALIDATOR_KEY);
                if (selettore && validatore) {
                    try {
                        const tokenData = await fetchAPI('check_session.php', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ selettore, validatore })
                        });
                        if (tokenData.user.ruolo === 'admin') { initializeAdminView(tokenData.user); }
                        else { clearTokenStorage(); showView('login'); }
                        return;
                    } catch (tokenError) { clearTokenStorage(); showView('login'); return; }
                }
                showView('login');
            }
        }
        
        function saveTokenStorage(token) {
            if (token && token.selettore && token.validatore) {
                localStorage.setItem(TOKEN_SELECTOR_KEY, token.selettore);
                localStorage.setItem(TOKEN_VALIDATOR_KEY, token.validatore);
            }
        }
        function clearTokenStorage() {
            localStorage.removeItem(TOKEN_SELECTOR_KEY);
            localStorage.removeItem(TOKEN_VALIDATOR_KEY);
        }

        async function handleLogin(e) {
            e.preventDefault(); clearLoginError();
            loginButton.disabled = true; loginButton.textContent = 'Accesso...';
            try {
                const data = await fetchAPI('login.php', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: usernameInput.value, password: passwordInput.value,
                        ricordami: ricordamiInput.checked
                    })
                });
                if (data.user.ruolo !== 'admin') {
                    showLoginError("Accesso riservato agli amministratori.");
                    await fetchAPI('logout.php'); return;
                }
                if (ricordamiInput.checked && data.token) { saveTokenStorage(data.token); }
                initializeAdminView(data.user);
            } catch (error) { showLoginError(error.message);
            } finally { loginButton.disabled = false; loginButton.textContent = 'Accedi'; }
        }
        
        async function handleLogout() {
            try {
                const selettore = localStorage.getItem(TOKEN_SELECTOR_KEY);
                await fetchAPI('logout.php', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selettore })
                });
            } catch (error) { console.error("Errore durante il logout:", error); }
            clearTokenStorage(); currentUser = null;
            usernameInput.value = ''; passwordInput.value = '';
            ricordamiInput.checked = false; showView('login');
        }
        
        // --- LOGICA ADMIN (NUOVA CON GRIGLIA) ---
        
        function populateFilterDropdowns() {
            const mesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            filterMese.innerHTML = '<option value="">-- Mese --</option>';
            mesi.forEach((nome, index) => { filterMese.innerHTML += `<option value="${index + 1}">${nome}</option>`; });
            
            const annoCorrente = new Date().getFullYear();
            filterAnno.innerHTML = '<option value="">-- Anno --</option>';
            for (let i = 0; i < 3; i++) {
                const anno = annoCorrente - i;
                filterAnno.innerHTML += `<option value="${anno}">${anno}</option>`;
            }
            filterMese.value = new Date().getMonth() + 1;
            filterAnno.value = annoCorrente;
        }
        
        /** Carica solo la lista utenti al primo avvio */
        async function loadInitialAdminData() {
            adminUsersBody.innerHTML = '<tr><td colspan="4" class="no-items-message" style="padding: 15px;">Caricamento...</td></tr>';
            try {
                const response = await fetchAPI('get_data.php'); // Chiamata senza filtri
                const data = response.data;
                listaUtenti = data.all_users; // Salva la lista
                
                populateUserList(data.all_users); // Popola tabella gestione
                populateUserFilter(data.all_users); // Popola filtro
                
            } catch (error) {
                if (String(error.message).includes("401")) { handleLogout(); }
                adminUsersBody.innerHTML = `<tr><td colspan="4" class="error">${error.message}</td></tr>`;
            }
        }
        
        /** Popola la tabella di Gestione Utenti */
        function populateUserList(users) {
            adminUsersBody.innerHTML = '';
            if (!users || users.length === 0) {
                adminUsersBody.innerHTML = '<tr><td colspan="4" class="no-items-message" style="padding: 15px;">Nessun utente.</td></tr>';
            } else {
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.cognome} ${user.nome}</td>
                        <td>${user.ruolo}</td>
                        <td><button class="button button-danger button-sm" data-id="${user.id}" data-username="${user.username}">Elimina</button></td>
                    `;
                    adminUsersBody.appendChild(tr);
                });
            }
        }
        
        /** Popola il <select> dei dipendenti nel filtro */
        function populateUserFilter(users) {
            filterDipendente.innerHTML = '<option value="">-- Seleziona dipendente --</option>';
            if (users && users.length > 0) {
                users.forEach(user => {
                    filterDipendente.innerHTML += `<option value="${user.id}">${user.cognome} ${user.nome}</option>`;
                });
            }
        }
        
        /** Chiamato quando si preme "Mostra" */
        async function handleFilterSubmit(e) {
            e.preventDefault();
            logTablePlaceholder.style.display = 'none';
            logTable.style.display = 'table';
            logTableHead.innerHTML = '<tr><th>Caricamento...</th></tr>';
            logTableBody.innerHTML = '';
            
            const dip = filterDipendente.value;
            const mese = filterMese.value;
            const anno = filterAnno.value;
            if (!dip || !mese || !anno) {
                alert('Seleziona dipendente, mese e anno.');
                logTableHead.innerHTML = '';
                logTablePlaceholder.style.display = 'block';
                return;
            }
            const queryString = `?dipendente=${dip}&mese=${mese}&anno=${anno}`;

            try {
                const response = await fetchAPI(`get_data.php${queryString}`);
                buildGridTable(response.data.grid_data);
            } catch (error) {
                if (String(error.message).includes("401")) { handleLogout(); }
                logTableHead.innerHTML = `<tr><th class="error">${error.message}</th></tr>`;
            }
        }
        
        /** COSTRUISCE LA GRIGLIA MENSILE */
        function buildGridTable(gridData) {
            if (!gridData) {
                logTableHead.innerHTML = '';
                logTableBody.innerHTML = '';
                logTablePlaceholder.textContent = 'Nessun dato trovato per questa selezione.';
                logTablePlaceholder.style.display = 'block';
                logTable.style.display = 'none';
                return;
            }
            
            const { giorni_nel_mese, max_colonne, timbrature_per_giorno } = gridData;
            
            // 1. Costruisci Header
            let headerHtml = '<tr><th>Giorno</th>';
            for (let i = 1; i <= max_colonne; i++) {
                headerHtml += `<th>Timbrata ${i}</th>`;
            }
            headerHtml += '</tr>';
            logTableHead.innerHTML = headerHtml;
            
            // 2. Costruisci Body
            let bodyHtml = '';
            for (let g = 1; g <= giorni_nel_mese; g++) {
                bodyHtml += '<tr>';
                bodyHtml += `<td>${g}</td>`; // Cella Giorno
                
                const timbrateDelGiorno = timbrature_per_giorno[g] || [];
                
                for (let i = 0; i < max_colonne; i++) {
                    const timbrata = timbrateDelGiorno[i];
                    if (timbrata) {
                        const mapsLink = `http://googleusercontent.com/maps/search/?api=1&query=${timbrata.lat},${timbrata.lon}`;
                        bodyHtml += `
                            <td>
                                <div class="orario">${timbrata.orario}</div>
                                <div class="tipo ${timbrata.tipo}">${timbrata.tipo === 'entrata' ? 'Entrata' : 'Uscita'}</div>
                                <div class="posizione">
                                    <a href="${mapsLink}" target="_blank">Vedi Mappa</a>
                                </div>
                            </td>`;
                    } else {
                        bodyHtml += '<td>-</td>'; // Cella vuota
                    }
                }
                bodyHtml += '</tr>';
            }
            logTableBody.innerHTML = bodyHtml;
        }

        /** Esporta Excel */
        function handleExportExcel() {
            const dip = filterDipendente.value;
            const mese = filterMese.value;
            const anno = filterAnno.value;
            if (!dip || !mese || !anno) {
                alert('Seleziona i filtri prima di esportare.');
                return;
            }
            const queryString = `?dipendente=${dip}&mese=${mese}&anno=${anno}`;
            window.open(API_BASE_URL + 'genera_excel.php' + queryString, '_blank');
        }
        
        /** Crea Utente */
        async function handleCreateUser(e) {
            e.preventDefault(); clearCreateError();
            try {
                await fetchAPI('manage_user.php', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        username: document.getElementById('new_username').value,
                        password: document.getElementById('new_password').value,
                        nome: document.getElementById('new_nome').value,
                        cognome: document.getElementById('new_cognome').value,
                        ruolo: document.getElementById('new_ruolo').value
                    })
                });
                createUserForm.reset();
                alert('Utente creato con successo!');
                loadInitialAdminData(); // Ricarica la lista utenti
            } catch (error) { showCreateError(error.message); }
        }
        
        /** Elimina Utente */
        async function handleDeleteUser(e) {
            if (!e.target.classList.contains('button-danger')) return;
            const id = e.target.dataset.id;
            const username = e.target.dataset.username;
            if (!confirm(`Sei sicuro di voler eliminare l'utente "${username}"? Questa azione è irreversibile e cancellerà tutte le sue timbrature.`)) { return; }
            try {
                await fetchAPI('manage_user.php', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', user_id: id })
                });
                alert('Utente eliminato.');
                loadInitialAdminData(); // Ricarica la lista
            } catch (error) { alert(`Errore: ${error.message}`); }
        }
        
        /** Setup Tabs */
        function setupTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));
                    link.classList.add('active');
                    const tabId = 'tab-' + link.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => { showView('loading'); checkSession(); });
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        filterForm.addEventListener('submit', handleFilterSubmit);
SERVICE_CALL_REPLIED
        exportExcelButton.addEventListener('click', handleExportExcel);
        createUserForm.addEventListener('submit', handleCreateUser);
        adminUsersBody.addEventListener('click', handleDeleteUser);
    </script>
</body>
</html>